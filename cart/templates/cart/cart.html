{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Your Cart</h1>
  {% if cart_items %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th style="width:64px;">Item Image</th>
          <th>Item</th>
          <th class="text-center">Grind</th>
          <th class="text-center">Weight</th>
          <th class="text-center">Qty</th>
          <th class="text-end">Unit</th>
          <th class="text-end">Line</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in cart_items %}
        <tr>
          <td>
            <a href="#"
               class="cart-item-trigger d-inline-block"
               data-bs-toggle="modal"
               data-bs-target="#cartItemModal"
               data-name="{{ item.name }}"
               data-image="{{ item.image_url }}"
               data-price="€{{ item.price }}"
               data-qty="{{ item.quantity }}"
               data-grind="{{ item.grind|default:'' }}"
               data-weight="{{ item.weight_grams|default:'' }}"
               data-sku="{{ item.sku|default:'' }}"
                {% if item.product_slug %}data-url="{% url 'products:product_detail' item.product_slug %}"{% else %}data-url=""{% endif %}>
              <img src="{{ item.image_url }}"
                   alt="{{ item.name }}"
                   class="rounded shadow-sm"
                   style="width:48px;height:48px;object-fit:cover;cursor:zoom-in;">
            </a>
          </td>
          <td class="fw-semibold">
            {{ item.name }}
            {% if item.variant_label %}
              <div class="small text-muted">{{ item.variant_label }}</div>
            {% endif %}
          </td>
          <td class="text-center">{{ item.grind|default:"—" }}</td>
          <td class="text-center">
            {% if item.weight_grams %}{{ item.weight_grams }}g{% else %}—{% endif %}
          </td>
          <td class="text-center">{{ item.quantity }}</td>
          <td class="text-end">€{{ item.price }}</td>
          <td class="text-end">€{{ item.line_total }}</td>
          <td class="text-end">
            <!-- your existing remove/update actions if any -->
            <a href="{% url 'cart:remove' slug=item.key %}" class="btn btn-sm btn-outline-danger">Remove</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="6" class="text-end">Subtotal</th>
          <th class="text-end">€{{ subtotal }}</th>
        </tr>
        <tr>
          <th colspan="6" class="text-end">Shipping</th>
          <th class="text-end">€{{ shipping }}</th>
          
        </tr>
        <tr>
          <th colspan="6" class="text-end fs-5">Total</th>
          <th class="text-end fs-5">€{{ total }}</th>
         
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="d-flex justify-content-end mt-3 gap-2">
    <a class="btn btn-secondary" href="{% url 'products:product_list' %}">Continue shopping</a>
    <a class="btn btn-primary" href="{% url 'orders:checkout' %}">Checkout</a>
    <a href="{% url 'cart:clear' %}" class="btn btn-danger">Clear Cart</a>
  </div>
  {% else %}
    <p>Your cart is empty.</p>
    <a class="btn btn-primary" href="{% url 'products:product_list' %}">Shop now</a>
  {% endif %}
</div>

<!-- Reusable modal (one per page) -->
<div class="modal fade" id="cartItemModal" tabindex="-1" aria-labelledby="ciTitle" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content overflow-hidden">
      <div class="modal-body p-0">
        <div class="row g-0">
          <div class="col-md-6">
            <img
              id="ciImage"
              src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
              alt="Product image"
              class="w-100 h-100"
              style="object-fit:cover; min-height: 320px;">
          </div>
          <div class="col-md-6">
            <div class="p-4">
              <h4 id="ciTitle" class="mb-2">Product details</h4>
              <div class="text-muted mb-3" id="ciPrice"></div>
              <ul class="list-unstyled small mb-4" id="ciFacts"></ul>
              <div class="d-flex gap-2">
                <a id="ciViewBtn" href="#" class="btn btn-primary">View product</a>
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Close</button>
              </div>
            </div>
          </div>
        </div>        
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("click", function (e) {
    const a = e.target.closest(".cart-item-trigger");
    if (!a) return;

    const name   = a.dataset.name || "Item";
    const image  = a.dataset.image || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
    const price  = a.dataset.price || "";
    const qty    = a.dataset.qty || "";
    const grind  = a.dataset.grind || "";
    const weight = a.dataset.weight || "";
    const sku    = a.dataset.sku || "";
    const url    = a.dataset.url || "";

    // Fill modal
    const imgEl = document.getElementById("ciImage");
    imgEl.src = image; imgEl.alt = name;
    document.getElementById("ciTitle").textContent = name;
    document.getElementById("ciPrice").textContent = price;

    const facts = [];
    if (qty)    facts.push(`<li><strong>Quantity:</strong> ${qty}</li>`);
    if (grind)  facts.push(`<li><strong>Grind:</strong> ${grind}</li>`);
    if (weight) facts.push(`<li><strong>Weight:</strong> ${weight}g</li>`);
    if (sku)    facts.push(`<li><strong>SKU:</strong> ${sku}</li>`);
    document.getElementById("ciFacts").innerHTML = facts.join("");

    const viewBtn = document.getElementById("ciViewBtn");
    if (url) {
      viewBtn.href = url;
      viewBtn.classList.remove("disabled");
    } else {
      viewBtn.href = "#";
      viewBtn.classList.add("disabled");
    }
  });
</script>
{% endblock %}
